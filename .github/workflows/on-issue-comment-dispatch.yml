name: Issue Comment Dispatcher

on:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to dispatch'
        required: true
        type: string
      dispatch_target:
        description: 'Which phase to dispatch to'
        required: true
        type: choice
        options:
          - phase1
          - phase2
          - assignment

permissions:
  actions: write
  contents: read

concurrency:
  group: issue-comment-dispatch-${{ inputs.issue_number || github.event.issue.number }}
  cancel-in-progress: false

jobs:
  dispatch:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.issue.pull_request == null }}
    runs-on: ubuntu-latest
    env:
      ISSUE_NUMBER: ${{ inputs.issue_number || github.event.issue.number }}
      REF: ${{ github.event.repository.default_branch || github.ref_name }}
    steps:
      - name: Dispatch to phase 1
        if: >-
          ${{
            (github.event_name == 'workflow_dispatch' && inputs.dispatch_target == 'phase1') ||
            (github.event_name == 'issue_comment' && contains(github.event.comment.body, 'AI generated by [GH-AW Issue Research Pass]'))
          }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh workflow run "issue-phase1-dispatch.yml" \
            --repo "${{ github.repository }}" \
            --ref "${REF}" \
            -f issue_number="${ISSUE_NUMBER}"

      - name: Dispatch to phase 2
        if: >-
          ${{
            (github.event_name == 'workflow_dispatch' && inputs.dispatch_target == 'phase2') ||
            (github.event_name == 'issue_comment' && contains(github.event.comment.body, 'AI generated by [GH-AW Issue Phase 1 ('))
          }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh workflow run "issue-phase2-dispatch.yml" \
            --repo "${{ github.repository }}" \
            --ref "${REF}" \
            -f issue_number="${ISSUE_NUMBER}"

      - name: Dispatch to assignment
        if: >-
          ${{
            (github.event_name == 'workflow_dispatch' && inputs.dispatch_target == 'assignment') ||
            (github.event_name == 'issue_comment' && contains(github.event.comment.body, 'AI generated by [GH-AW Issue Phase 2 ('))
          }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh workflow run "issue-assignment-dispatch.yml" \
            --repo "${{ github.repository }}" \
            --ref "${REF}" \
            -f issue_number="${ISSUE_NUMBER}"
