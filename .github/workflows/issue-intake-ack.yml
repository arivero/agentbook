name: Issue Intake ACK + Route Dispatch

on:
  issues:
    types: [opened]

permissions:
  actions: write
  contents: read
  issues: write

jobs:
  acknowledge-and-dispatch:
    if: ${{ github.event.issue.pull_request == null }}
    runs-on: ubuntu-latest
    steps:
      - name: Acknowledge issue and apply intake label
        uses: actions/github-script@v8
        with:
          github-token: ${{ github.token }}
          script: |
            const issueNumber = context.issue.number;
            const { owner, repo } = context.repo;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: "Thanks for opening this suggestion. It has been acknowledged and is now queued for agentic routing.",
            });

            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: issueNumber,
              labels: ["acknowledged"],
            });

      - name: Dispatch routing workflow
        uses: actions/github-script@v8
        with:
          github-token: ${{ github.token }}
          script: |
            const issueNumber = context.issue.number;
            const { owner, repo } = context.repo;
            const ref = context.payload.repository.default_branch;

            await github.rest.actions.createWorkflowDispatch({
              owner,
              repo,
              workflow_id: "issue-routing-decision.lock.yml",
              ref,
              inputs: {
                issue_number: String(issueNumber),
              },
            });
