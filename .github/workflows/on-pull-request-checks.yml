name: PR Checks

on:
  pull_request:
    paths:
      - 'book/**/*.md'
      - 'scripts/check-links.py'
      - '.github/workflows/*.md'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  check-links:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Run internal link checker (offline-safe)
        run: python3 scripts/check-links.py --root book --mode internal

  compile-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install gh-aw extension
        run: gh extension install github/gh-aw
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Compile agentic workflows
        run: gh aw compile daily-research-updates issue-assignment-close issue-fast-track-close issue-phase1-claude issue-phase1-codex issue-phase1-copilot issue-phase2-claude issue-phase2-codex issue-phase2-copilot issue-research-pass issue-routing-decision weekly-editorial-quality
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Verify lock files are up to date
        run: |
          if ! git diff --quiet -- .github/workflows/*.lock.yml; then
            echo "::error::Lock files are out of date. Run 'gh aw compile' locally and commit the results."
            git diff -- .github/workflows/*.lock.yml
            exit 1
          fi
          echo "All .lock.yml files are up to date."
